# Alert Service

***
## [Overall Purpose](#overall-purpose)
This project is developed based on `Data Processor` and the main purpose is to capture potential warnings in the database design generated by the above project. And to make it available to the front-end service or CLI service through API. The project is developed using Spring Boot framework , mainly using Spring MVC , Mybaits, H2 Database  framework . Use Maven for dependency management.
The program offers two modes of operation: periodic rotations and specified time periods for queries. 
- The first way allows this service to run a rotation based on Cron expressions without repeating the analysis on the already analyzed data.
- The second way is to specify the query for a certain time period, and perform data query and analysis for that time period

### Data Design

 [SCHEMA:hunting_service.uml](help/SCHEMA:hunting_service.uml) 

## [Hunting Job](#hunting-job)
The project currently has one task: Hunting Job, which analyzes the data of all Vav devices, mainly choosing `zone_temperature` as the metric. When a certain Vav device has several consecutive abnormalities in a certain time period, it will be marked as an alarm.
In this project, we set the time window to **3 hours** and the threshold for the **number of anomalies to 12** (6 round trips) The default valid data period is 6:00AM to 6:00PM on weekdays . The range of anomalies is:

```java
zone_temperature > zone_cooling_temperature_set_point || zone_temperature < zone_heating_temperature_set_point
```

That is, any vav device that crosses the normal value range more than 12 times in any three hour period will be considered to generate an alarm at the time of the data point of the last crossing behavior. The above thresholds for the length of the time window and the number of exceptions can be adjusted in `edu.neu.cs6510.pnnl.hunting.utils.ConfigConst`:

```java
    public static long ONE_HOUR = 3600000L;
    public static long HUNTING_TIME_WINDOW = ONE_HOUR * 3;
    public static int WARNING = 12;
    public static int WORK_HOUR_START_TIME = 6;
    public static int WORK_HOUR_END_TIME = 18;
```
The alerts fetched by this Job will be written to the in-memory H2 database waiting to be read.

***
## [API](#api)

The APIs currently available are 

- `GET hunting/hunting/today` : The API does not require any additional parameters to be passed in and the return value will be provided as a json. Each request performs a database query, but is extremely efficient because it uses the In-Memory database. [Swagger](https://app.swaggerhub.com/apis-docs/ChengS-U/PNNL_Alert_Service/1.0.0) can be used for further insight.

  - Response:

    ```json
    {
        "msg": "success",
        "2019-11-30 18:28:00 - vav108": [
            {
                "zoneCoolingTemperatureSetPoint": 74.0,
                "zoneHeatingTemperatureSetPoint": 70.0,
                "zoneTemperature": 68.0,
                "vavName": "vav108",
                "time": "2019-11-30 15:28:00"
            },...
          ], ...
          "code": 0
    }      
    ```

***
## [Main File](#main-file)
- `edu.neu.cs6510.pnnl.hunting.config.QuartzConfig`: Adjust the running frequency and time of jobs
- `edu.neu.cs6510.pnnl.hunting.job.HuntingJob`: The core business class of Hunting Job, where all the analysis algorithms are implemented
- `src/main/resources/application.yml`: All configurations for the application are located in this file

  Note: Spring Boot support use start parameter to launch application, you can use `-D"any.spring.conig"="anyvalue"`(Without quote) to set any sensetive data like Database infomation. 

***
## [License](#license)

 Alert Service is provided under the  [GNU General Public License v3.0](https://github.com/PNNL-Project/react-app/blob/main/LICENSE).

